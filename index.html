<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XML/XSL Presentation with Bootstrap</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Custom presentation styles -->
    <link rel="stylesheet" href="presentation-custom.css">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>
    <script>
        window.addEventListener('DOMContentLoaded', function() {
            console.log("DOM loaded, beginning XML processing");

            // Add this at the beginning of your DOMContentLoaded event in index.html
            window.onerror = function(message, source, lineno, colno, error) {
                console.error("Global error caught:", message, "at", source, ":", lineno);
                return false;
            };
            
            try {
                // Show what files we're trying to load
                const xmlFilename = 'investor-pitch.xml';
                const xslFilename = 'presentation.xsl';
                
                console.log("Attempting to load XML:", xmlFilename);
                console.log("Attempting to load XSL:", xslFilename);
                
                // Load the XML and XSL files
                const xmlRequest = new XMLHttpRequest();
                xmlRequest.open('GET', xmlFilename, false);
                xmlRequest.send();
                
                if (xmlRequest.status === 200 || xmlRequest.status === 0) {
                    console.log("XML loaded successfully");
                } else {
                    console.error("Failed to load XML:", xmlRequest.statusText);
                }
                
                const xslRequest = new XMLHttpRequest();
                xslRequest.open('GET', xslFilename, false);
                xslRequest.send();
                
                if (xslRequest.status === 200 || xslRequest.status === 0) {
                    console.log("XSL loaded successfully");
                } else {
                    console.error("Failed to load XSL:", xslRequest.statusText);
                }
                
                // Transform the XML using the XSL
                console.log("Beginning transformation");
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlRequest.responseText, 'text/xml');
                const xslDoc = parser.parseFromString(xslRequest.responseText, 'text/xml');
                
                const processor = new XSLTProcessor();
                processor.importStylesheet(xslDoc);
                const resultDoc = processor.transformToFragment(xmlDoc, document);
                
                // Get theme attribute from XML for Bootstrap theme
                const presentationNode = xmlDoc.querySelector('presentation');
                const theme = presentationNode ? presentationNode.getAttribute('theme') : 'light';
                
                if (theme) {
                    document.documentElement.setAttribute('data-bs-theme', theme);
                    console.log("Applied theme:", theme);
                }
                
                // Get presentation title
                const titleNode = xmlDoc.querySelector('presentation > metadata > title');
                if (titleNode && titleNode.textContent) {
                    document.title = titleNode.textContent;
                }
                
                // Replace the loading spinner with the transformed content
                console.log("Transformation complete, updating content");
                const mainContent = document.getElementById('presentation-content');
                mainContent.innerHTML = '';
                mainContent.appendChild(resultDoc);

                // Hide loading spinner
                //document.getElementById('loading-spinner').style.display = 'none';
                const spinner = document.getElementById('loading-spinner');
                if (spinner) {
                    spinner.style.display = 'none';
                    spinner.style.visibility = 'hidden';
                    //spinner.classList.add('d-none'); // Bootstrap's display none utility
                }

                // Apply any dynamic styles from the presentation
                const brandNode = xmlDoc.querySelector('presentation > metadata > brand');
                if (brandNode) {
                    const dynamicStyles = document.createElement('style');
                    let cssVars = ':root {\n';
                    
                    const colorNodes = brandNode.querySelectorAll('color');
                    colorNodes.forEach(colorNode => {
                        const name = colorNode.getAttribute('name');
                        const value = colorNode.textContent;
                        
                        if (name && value) {
                            switch(name) {
                                case 'primary': cssVars += '  --bs-primary: ' + value + ';\n'; break;
                                case 'secondary': cssVars += '  --bs-secondary: ' + value + ';\n'; break;
                                case 'accent': cssVars += '  --bs-info: ' + value + ';\n'; break;
                                case 'text': cssVars += '  --bs-body-color: ' + value + ';\n'; break;
                                case 'background': cssVars += '  --bs-body-bg: ' + value + ';\n'; break;
                            }
                        }
                    });
                    
                    cssVars += '}';
                    dynamicStyles.textContent = cssVars;
                    document.head.appendChild(dynamicStyles);
                    console.log("Applied dynamic styles");
                }
                
                // Load presentation JavaScript
                console.log("Loading presentation.js");
                const script = document.createElement('script');
                script.src = 'presentation.js';
                script.onload = function() {
                    console.log("presentation.js has loaded successfully");
                };
                document.body.appendChild(script);
            } catch (error) {
                console.error("Error in presentation processing:", error);
                document.getElementById('loading-spinner').style.display = 'none';
                document.getElementById('loading-spinner').style.visibility =
                    'hidden';
                document.getElementById('presentation-content').innerHTML = `
                    <div class="container mt-5">
                        <div class="alert alert-danger">
                            <h4>Error Loading Presentation</h4>
                            <p>${error.message}</p>
                            <p>Check the console for more details.</p>
                        </div>
                    </div>
                `;
            }
        });
    </script>
</head>
<body>
    <!-- Loading spinner -->
    <div id="loading-spinner" class="container d-flex justify-content-center align-items-center min-vh-100">
        <div class="text-center">
            <div class="spinner-border text-primary mb-3" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <h2 class="h4 mb-3">Loading presentation...</h2>
            <p class="text-muted">Please wait while the presentation is being prepared.</p>
        </div>
    </div>
    
    <!-- Presentation content will be inserted here -->
    <div id="presentation-content"></div>
    
    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
