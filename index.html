<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="XML/XSL Presentation System with Bootstrap">
    <title>XML/XSL Presentation with Bootstrap</title>
    
    <!-- favicon -->
    <link rel="icon" type="image/svg+xml" href="assets/images/favicon.svg" />
    <link rel="alternate icon" type="image/png" href="assets/images/favicon.png" />
    <link rel="apple-touch-icon" href="assets/images/apple-touch-icon.png" />

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Custom presentation styles -->
    <link rel="stylesheet" href="assets/css/presentation-custom.css">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>
</head>
<body>
    <!-- Loading spinner -->
    <div id="loading-spinner" class="container d-flex justify-content-center align-items-center min-vh-100">
        <div class="text-center">
            <div class="spinner-border text-primary mb-3" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <h2 class="h4 mb-3">Loading presentation...</h2>
            <p class="text-muted">Please wait while the presentation is being prepared.</p>
        </div>
    </div>
    
    <!-- Error message container -->
    <div id="error-container" class="container mt-5 d-none">
        <div class="alert alert-danger">
            <h4 class="alert-heading">Error Loading Presentation</h4>
            <p id="error-message">An unexpected error occurred while loading the presentation.</p>
            <hr>
            <p class="mb-0">Please check the console for more details or try refreshing the page.</p>
        </div>
    </div>
    
    <!-- Presentation content will be inserted here -->
    <div id="presentation-content"></div>
    
    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            console.log("DOM loaded, beginning XML processing");
            
            // Global error handler
            window.addEventListener('error', function(event) {
                console.error("Global error caught:", event.message);
                showError(event.message);
                return false;
            });
            
            try {
                // Configuration
                const config = {
                    xmlFilename: 'examples/investor-pitch.xml',
                    xslFilename: 'templates/presentation.xsl'
                };
                
                // Load files using modern fetch API with Promise.all for parallel loading
                console.log(`Loading XML: ${config.xmlFilename} and XSL: ${config.xslFilename}`);
                
                const [xmlResponse, xslResponse] = await Promise.all([
                    fetch(config.xmlFilename),
                    fetch(config.xslFilename)
                ]);
                
                // Check responses
                if (!xmlResponse.ok) {
                    throw new Error(`Failed to load XML: ${xmlResponse.statusText}`);
                }
                
                if (!xslResponse.ok) {
                    throw new Error(`Failed to load XSL: ${xslResponse.statusText}`);
                }
                
                // Get text content
                const [xmlText, xslText] = await Promise.all([
                    xmlResponse.text(),
                    xslResponse.text()
                ]);
                
                console.log("Files loaded successfully, processing XML/XSL");
                
                // Parse XML and XSL
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlText, 'text/xml');
                const xslDoc = parser.parseFromString(xslText, 'text/xml');
                
                // Check for parsing errors
                const xmlParseError = xmlDoc.querySelector('parsererror');
                if (xmlParseError) {
                    throw new Error(`XML parsing error: ${xmlParseError.textContent}`);
                }
                
                const xslParseError = xslDoc.querySelector('parsererror');
                if (xslParseError) {
                    throw new Error(`XSL parsing error: ${xslParseError.textContent}`);
                }
                
                // Transform XML using XSL
                console.log("Beginning transformation");
                const processor = new XSLTProcessor();
                processor.importStylesheet(xslDoc);
                const resultDoc = processor.transformToFragment(xmlDoc, document);
                
                // Apply presentation theme
                applyPresentationTheme(xmlDoc);
                
                // Update the content
                console.log("Transformation complete, updating content");
                const mainContent = document.getElementById('presentation-content');
                mainContent.innerHTML = '';
                mainContent.appendChild(resultDoc);
                
                // Hide loading spinner
                document.getElementById('loading-spinner').classList.add('d-none');
                
                // Load presentation JavaScript
                console.log("Loading presentation.js");
                await loadScript('js/presentation.js');
                console.log("presentation.js loaded successfully");
                
            } catch (error) {
                console.error("Error in presentation processing:", error);
                showError(error.message);
            }
        });
        
        /**
         * Apply theme and styling from the presentation XML
         */
        function applyPresentationTheme(xmlDoc) {
            try {
                // Get theme attribute for Bootstrap theme
                const presentationNode = xmlDoc.querySelector('presentation');
                const theme = presentationNode?.getAttribute('theme') || 'light';
                
                document.documentElement.setAttribute('data-bs-theme', theme);
                console.log("Applied theme:", theme);
                
                // Set page title
                const titleNode = xmlDoc.querySelector('presentation > metadata > title');
                if (titleNode?.textContent) {
                    document.title = titleNode.textContent;
                    console.log("Updated title:", titleNode.textContent);
                }
                
                // Apply brand colors
                const brandNode = xmlDoc.querySelector('presentation > metadata > brand');
                if (brandNode) {
                    const dynamicStyles = document.createElement('style');
                    let cssVars = ':root {\n';
                    
                    const colorMap = {
                        'primary': '--bs-primary',
                        'secondary': '--bs-secondary',
                        'accent': '--bs-info',
                        'text': '--bs-body-color',
                        'background': '--bs-body-bg'
                    };
                    
                    const colorNodes = brandNode.querySelectorAll('color');
                    colorNodes.forEach(colorNode => {
                        const name = colorNode.getAttribute('name');
                        const value = colorNode.textContent;
                        
                        if (name && value && colorMap[name]) {
                            cssVars += `  ${colorMap[name]}: ${value};\n`;
                        }
                    });
                    
                    cssVars += '}';
                    dynamicStyles.textContent = cssVars;
                    document.head.appendChild(dynamicStyles);
                    console.log("Applied dynamic styles");
                }
            } catch (error) {
                console.warn("Theme application error:", error);
                // Non-critical error, continue loading
            }
        }
        
        /**
         * Load a script asynchronously
         */
        function loadScript(src) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = () => resolve();
                script.onerror = () => reject(new Error(`Failed to load script: ${src}`));
                document.body.appendChild(script);
            });
        }
        
        /**
         * Show error message to the user
         */
        function showError(message) {
            document.getElementById('loading-spinner').classList.add('d-none');
            
            const errorContainer = document.getElementById('error-container');
            const errorMessage = document.getElementById('error-message');
            
            errorMessage.textContent = message || 'Unknown error occurred while loading the presentation.';
            errorContainer.classList.remove('d-none');
        }
    </script>
</body>
</html>
